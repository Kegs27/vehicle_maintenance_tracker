<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oil Change Management - Vehicle Maintenance Tracker</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/static/app-styles.css" rel="stylesheet">
    <link href="/static/icon-styles.css" rel="stylesheet">
    <style>
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 1020;
        }
        
        .oil-change-table {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        
        .oil-change-table thead th {
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .oil-change-table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .scrollable-table {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #6c757d #f8f9fa;
        }
        
        .scrollable-table::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-table::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 3px;
        }
        
        .scrollable-table::-webkit-scrollbar-thumb {
            background: #6c757d;
            border-radius: 3px;
        }
        
        .scrollable-table::-webkit-scrollbar-thumb:hover {
            background: #495057;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    {% include 'nav.html' %}

    <!-- Header -->
    <header class="bg-primary text-white py-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-4">
                        <i class="fas fa-oil-can me-3"></i>Oil Change Management
                    </h1>
                    <p class="lead mb-0">Track oil change history and due dates across your fleet</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/maintenance/new?return_url=/oil-changes" class="btn btn-light btn-lg">
                        <i class="fas fa-plus me-2"></i>Add Oil Change
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-5">
        <div class="container">
            <!-- Summary Cards -->
            <div class="row g-4 mb-5">
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body p-4">
                            <i class="fas fa-exclamation-triangle text-danger mb-3" style="font-size: 2rem;"></i>
                            <h3 class="text-danger mb-2">
                                {{ vehicle_oil_data | selectattr('next_due_info.status', 'equalto', 'overdue') | list | length }}
                            </h3>
                            <p class="text-muted mb-0">Overdue</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body p-4">
                            <i class="fas fa-clock text-warning mb-3" style="font-size: 2rem;"></i>
                            <h3 class="text-warning mb-2">
                                {{ vehicle_oil_data | selectattr('next_due_info.status', 'equalto', 'due_soon') | list | length }}
                            </h3>
                            <p class="text-muted mb-0">Due Soon</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body p-4">
                            <i class="fas fa-check-circle text-success mb-3" style="font-size: 2rem;"></i>
                            <h3 class="text-success mb-2">
                                {{ vehicle_oil_data | selectattr('next_due_info.status', 'equalto', 'good') | list | length }}
                            </h3>
                            <p class="text-muted mb-0">Good Standing</p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="card border-0 shadow-sm text-center">
                        <div class="card-body p-4">
                            <i class="fas fa-car text-info mb-3" style="font-size: 2rem;"></i>
                            <h3 class="text-info mb-2">{{ vehicle_oil_data | length }}</h3>
                            <p class="text-muted mb-0">Total Vehicles</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vehicle Oil Change Details -->
            <div class="row g-4">
                {% for data in vehicle_oil_data %}
                <div class="col-12">
                    <div class="card border-0 shadow-sm" style="background-color: #f8f9fa; border: 2px solid #dee2e6 !important;">
                        <div class="card-header bg-light">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0">
                                        <i class="fas fa-car me-2"></i>{{ data.vehicle.name }}
                                    </h5>
                                    <small class="text-muted">{{ data.vehicle.year }} {{ data.vehicle.make }} {{ data.vehicle.model }}</small>
                                    <br>
                                    <small class="text-info">
                                        <i class="fas fa-tachometer-alt me-1"></i>
                                        Current Mileage: {{ "{:,}".format(data.current_mileage) }}
                                        {% if data.next_due_info %}
                                            | Status: {{ data.next_due_info.status.replace('_', ' ').title() }}
                                        {% endif %}
                                    </small>
                                    <br>
                                    <a href="/oil-analysis/{{ data.vehicle.id }}" class="btn btn-outline-info btn-sm mt-2">
                                        <i class="fas fa-flask me-1"></i>Oil Analysis
                                    </a>
                                </div>
                                <div class="col-md-6 text-end">
                                    {% if data.next_due_info %}
                                        {% if data.next_due_info.status == 'overdue' %}
                                            <span class="badge bg-danger fs-6">OVERDUE</span>
                                        {% elif data.next_due_info.status == 'due_soon' %}
                                            <span class="badge bg-warning fs-6">DUE SOON</span>
                                        {% else %}
                                            <span class="badge bg-success fs-6">GOOD</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary fs-6">NO DATA</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Current Status -->
                                <div class="col-md-4">
                                    <h6 class="text-muted mb-3">Current Status</h6>
                                    {% if data.current_mileage > 0 %}
                                        <p class="mb-2">
                                            <strong>Current Mileage:</strong><br>
                                            <span class="fs-5 text-primary">{{ "{:,}".format(data.current_mileage) }} miles</span>
                                        </p>
                                    {% else %}
                                        <p class="text-muted">No mileage data available</p>
                                    {% endif %}
                                    
                                    {% if data.next_due_info %}
                                        <p class="mb-2">
                                            <strong>Oil Change Interval:</strong><br>
                                            <span class="text-info">{{ "{:,}".format(data.next_due_info.interval) }} miles</span>
                                        </p>
                                        
                                        {% if data.next_due_info.status == 'overdue' %}
                                            <p class="mb-0">
                                                <strong>Status:</strong><br>
                                                <span class="text-danger">Overdue by {{ "{:,}".format(-data.next_due_info.miles_until_due) }} miles</span>
                                            </p>
                                        {% elif data.next_due_info.status == 'due_soon' %}
                                            <p class="mb-0">
                                                <strong>Status:</strong><br>
                                                <span class="text-warning">{{ "{:,}".format(data.next_due_info.miles_until_due) }} miles until due</span>
                                            </p>
                                        {% else %}
                                            <p class="mb-0">
                                                <strong>Status:</strong><br>
                                                <span class="text-success">{{ "{:,}".format(data.next_due_info.miles_until_due) }} miles until due</span>
                                            </p>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted">No oil change records found</p>
                                    {% endif %}
                                </div>
                                
                                <!-- Oil Change History -->
                                <div class="col-md-8">
                                    <h6 class="text-muted mb-3">
                                        Oil Change History 
                                        <span class="badge bg-primary ms-2">{{ data.oil_changes|length }}</span>
                                    </h6>
                                    
                                    {% if data.oil_changes %}
                                        <div class="table-responsive scrollable-table">
                                            <table class="table table-sm table-hover oil-change-table">
                                                <thead class="sticky-top bg-light">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Mileage</th>
                                                        <th>Interval</th>
                                                        <th>Cost</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for oil_change in data.oil_changes %}
                                                    <tr>
                                                        <td>{{ oil_change.date.strftime('%m/%d/%Y') }}</td>
                                                        <td>{{ "{:,}".format(oil_change.mileage) }} miles</td>
                                                        <td>
                                                            {% if oil_change.oil_change_interval %}
                                                                {{ "{:,}".format(oil_change.oil_change_interval) }} miles
                                                            {% else %}
                                                                <span class="text-muted">Not set</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if oil_change.cost %}
                                                                ${{ "%.2f"|format(oil_change.cost) }}
                                                            {% else %}
                                                                <span class="text-muted">N/A</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            <a href="/maintenance/{{ oil_change.id }}/edit?return_url=/oil-changes" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-oil-can mb-3" style="font-size: 2rem;"></i>
                                            <p>No oil change records found for this vehicle.</p>
                                            <a href="/maintenance/new?return_url=/oil-changes" class="btn btn-primary">
                                                <i class="fas fa-plus me-2"></i>Add First Oil Change
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p class="text-muted mb-0">
                <i class="fas fa-oil-can me-2"></i>
                Oil Change Management System
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
