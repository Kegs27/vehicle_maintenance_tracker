<!-- Reusable Navigation Component -->
{% set _current_account = (account_context.get('account') if account_context and account_context is mapping else None) %}
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/">
            <i class="fa-solid fa-car me-2"></i>
            Vehicle Maintenance Tracker
        </a>
        <div class="ms-auto header-actions">
            <div class="dropdown">
                <button class="btn-account dropdown-toggle" type="button"
                        id="accountDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                    {{ _current_account.name if _current_account else "Account" }}
                    <i class="fa-solid fa-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" id="accountDropdownMenu"
                    aria-labelledby="accountDropdownButton">
                    <!-- populated by app-functions.js -->
                </ul>
            </div>
            <div class="dropdown position-relative">
                <button class="btn-icon dropdown-toggle position-relative" type="button"
                        data-bs-toggle="dropdown" aria-label="Notifications">
                    <i class="fa-solid fa-bell"></i>
                    <span id="notificationCount"
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                          style="display:none;">0</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end p-0">
                    <p class="dropdown-item text-muted small mb-0">No new notifications</p>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn-icon dropdown-toggle" type="button" id="mainNavDropdown"
                        data-bs-toggle="dropdown" aria-label="Menu">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="mainNavDropdown">
                    <li class="dropdown-header">
                        <span class="text-muted text-uppercase small fw-semibold d-block">Navigate</span>
                    </li>
                    <li><a class="dropdown-item" href="/vehicles" data-account-aware="true">Vehicles</a></li>
                    <li><a class="dropdown-item" href="/maintenance" data-account-aware="true">Maintenance</a></li>
                    <li><a class="dropdown-item" href="/oil-management" data-account-aware="true">Oil Management</a></li>
                    <li><a class="dropdown-item" href="/fuel-new" data-account-aware="true">Fuel Tracking</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="dropdown-header">
                        <span class="text-muted text-uppercase small fw-semibold d-block">Data Transfer</span>
                    </li>
                    <li><a class="dropdown-item" href="#" data-action="open-import"><i class="fa-solid fa-file-arrow-up me-2"></i>Import Data (CSV)</a></li>
                    <li><a class="dropdown-item" href="#" data-action="open-export"><i class="fa-solid fa-file-arrow-down me-2"></i>Export Data</a></li>
                    <li><a class="dropdown-item" href="/data-transfer"><i class="fa-solid fa-right-left me-2"></i>Data Transfer Page</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<!-- Notifications Modal -->
<div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationsModalLabel">
                    <span class="icon-row">
                        <i class="fa-solid fa-bell icon-s icon-base icon-primary" aria-hidden="true"></i>
                        <span>Maintenance Alerts</span>
                    </span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="notificationsList">
                    <!-- Notifications will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-action btn-action-outline" data-bs-dismiss="modal">
                    <i class="fa-solid fa-xmark"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Core app functions (needed for account dropdown) -->
{% set __account_ctx = account_context|default({}) %}
{% set __account_id = __account_ctx.get('account_id') if __account_ctx is mapping else None %}
{% set __account_scope = __account_ctx.get('scope') if __account_ctx is mapping else None %}
{% set __account_obj = __account_ctx.get('account') if __account_ctx is mapping else None %}
{% set __account_name = __account_obj.name if __account_obj else None %}
<script>
    window.__ACCOUNT_CONTEXT__ = window.__ACCOUNT_CONTEXT__ || {
        account_id: {{ __account_id|tojson }},
        scope: {{ __account_scope|tojson }},
        account_name: {{ __account_name|tojson }}
    };
</script>
<script src="/static/app-functions.js"></script>
<!-- Export functionality script -->
<script src="/static/export-data.js"></script>

<!-- Notification System Styles -->
<style>
    /* Mobile optimization for notification bell */
    @media (max-width: 768px) {
        .notification-bell .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .notification-bell .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    }
</style>

<!-- Notification System Script -->
<script>
    // Load notifications when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Build account dropdown
        if (window.initializeAccountSwitcher) {
            initializeAccountSwitcher();
        }
        loadNotifications();
    });
    
    function loadNotifications() {
        fetch('/api/notifications')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    updateNotificationCount(data.total_count, data.has_overdue);
                    populateNotificationsList(data.notifications);
                } else {
                    console.error('API returned error:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading notifications:', error);
                // Hide notification count on error
                const badge = document.getElementById('notificationCount');
                if (badge) badge.style.display = 'none';
            });
    }
    
    function updateNotificationCount(count, hasOverdue = false) {
        const badge = document.getElementById('notificationCount');
        if (count > 0) {
            badge.style.display = 'block';
            badge.textContent = count;
            
            // Update badge color based on urgency
            if (hasOverdue) {
                badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                badge.style.transform = '';
            } else {
                badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning';
                badge.style.transform = '';
            }
        } else {
            badge.style.display = 'none';
        }
    }
    
    function populateNotificationsList(notifications) {
        const list = document.getElementById('notificationsList');
        if (notifications.length === 0) {
            list.innerHTML = '<p class="text-muted text-center">No maintenance alerts at this time.</p>';
            return;
        }
        
        let html = '';
        notifications.forEach(notification => {
            const urgencyClass = notification.urgency === 'high' ? 'text-danger' : 'text-warning';
            const urgencyText = notification.urgency === 'high' ? 'Overdue' : 'Due Soon';
            
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border-bottom">
                    <div>
                        <a href="${notification.link}" class="text-decoration-none ${urgencyClass} fw-bold">
                            ${notification.type} - ${notification.vehicle}
                        </a>
                        <div class="small text-muted">${urgencyText}</div>
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
    }
    
    function showNotificationsModal() {
        const modal = new bootstrap.Modal(document.getElementById('notificationsModal'));
        modal.show();
    }
</script>
