<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oil Management - Vehicle Maintenance Tracker</title>
    
    {% include 'partials/head_resources.html' %}
    
    <style>
        .oil-vehicle-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .oil-vehicle-card:hover {
            border-color: #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }
        
        .oil-vehicle-card.expanded {
            border-color: #8b5cf6;
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.2);
        }
        
        .vehicle-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            padding: 1rem;
        }
        
        .vehicle-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        .vehicle-title {
            font-weight: 600;
            color: #495057;
            font-size: 1.1rem;
        }
        
        .oil-summary-details {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        .oil-vehicle-content {
            display: none;
            padding: 1.5rem;
        }
        
        .oil-vehicle-content.show {
            display: block;
        }
        
        .oil-detail-row {
            padding: 0.75rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .oil-detail-row:last-child {
            border-bottom: none;
        }
        
        .sort-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .sort-btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .sort-btn.active {
            background-color: #8b5cf6;
            border-color: #8b5cf6;
        }
        
        .analysis-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .analysis-linked {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .analysis-available {
            background-color: #d4edda;
            color: #155724;
        }
        
        .analysis-none {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons .btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        
        .modal-lg-custom {
            max-width: 800px;
        }
        
        .smart-detection {
            background-color: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .smart-detection.found {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        
        /* Mobile optimization */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .oil-card {
                margin-bottom: 0.75rem;
                border-radius: 8px;
            }
            
            .oil-card-header {
                padding: 0.75rem;
            }
            
            .oil-card-title {
                font-size: 0.95rem;
            }
            
            .oil-card-subtitle {
                font-size: 0.8rem;
            }
            
            .oil-card-body {
                padding: 0.75rem;
            }
            
            .oil-change-item,
            .oil-analysis-item {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                border-radius: 6px;
            }
            
            .oil-change-item h6,
            .oil-analysis-item h6 {
                font-size: 0.85rem;
            }
            
            .oil-change-item .text-muted,
            .oil-analysis-item .text-muted {
                font-size: 0.75rem;
            }
            
            .btn-group .btn {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
            
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .form-control,
            .form-select {
                font-size: 0.9rem;
            }
            
            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    {% from "partials/forms/macros.html" import field, text_input, number_input, money_input, select_input, textarea, field_error, date_input %}

    <!-- Navigation -->
    {% include 'nav.html' %}

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1 d-flex align-items-center gap-2">
                            <i class="fa-solid fa-oil-can icon-l icon-base icon-primary"></i>
                            <span>Oil Management</span>
                        </h2>
                        <p class="text-muted mb-0">Manage oil changes and analysis reports for all vehicles</p>
                    </div>
                </div>

                <!-- Sort Controls -->
                <div class="sort-controls">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-2 d-flex align-items-center gap-2">
                                <i class="fa-solid fa-sort icon-m icon-base"></i>
                                <span>Sort By:</span>
                            </h6>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary sort-btn" data-sort="vehicle-az">
                                    <span class="icon-row-sm">
                                        <i class="fa-solid fa-car icon-s icon-base"></i>
                                        <span>Vehicle A-Z</span>
                                    </span>
                                </button>
                                <button type="button" class="btn btn-outline-primary sort-btn" data-sort="vehicle-za">
                                    <span class="icon-row-sm">
                                        <i class="fa-solid fa-car icon-s icon-base"></i>
                                        <span>Vehicle Z-A</span>
                                    </span>
                                </button>
                                <button type="button" class="btn btn-outline-primary sort-btn active" data-sort="date-recent">
                                    <span class="icon-row-sm">
                                        <i class="fa-regular fa-calendar icon-s icon-base"></i>
                                        <span>Most Recent</span>
                                    </span>
                                </button>
                                <button type="button" class="btn btn-outline-primary sort-btn" data-sort="date-past">
                                    <span class="icon-row-sm">
                                        <i class="fa-regular fa-calendar icon-s icon-base"></i>
                                        <span>Oldest First</span>
                                    </span>
                                </button>
                                <button type="button" class="btn btn-outline-primary sort-btn" data-sort="mileage-high">
                                    <span class="icon-row-sm">
                                        <i class="fa-solid fa-gauge icon-s icon-base"></i>
                                        <span>High Mileage</span>
                                    </span>
                                </button>
                                <button type="button" class="btn btn-outline-primary sort-btn" data-sort="mileage-low">
                                    <span class="icon-row-sm">
                                        <i class="fa-solid fa-gauge icon-s icon-base"></i>
                                        <span>Low Mileage</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted icon-row">
                                <i class="fa-solid fa-circle-info icon-xs icon-base"></i>
                                <span>Click vehicle cards to expand details</span>
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Oil Cards -->
                <div id="oilCardsContainer">
                    {% for vehicle_data in vehicles_oil_data %}
                    {% set vehicle = vehicle_data.vehicle %}
                    {% set oil_status = vehicle_data.oil_status or {} %}
                    {% set raw_state = oil_status.state or 'ok' %}
                    {% set status_map = {'ok': 'status-normal', 'normal': 'status-normal', 'soon': 'status-soon', 'due': 'status-due'} %}
                    {% set status_class = status_map.get(raw_state, 'status-normal') %}
                    {% if raw_state not in status_map %}
                        <!-- unknown oil state: {{ raw_state }} -->
                    {% endif %}
                    {% set current_miles = oil_status.current_miles | default(None) %}
                    {% set last_change = oil_status.last_change_date | default(None) %}
                    {% set next_miles = oil_status.next_due_miles | default(None) %}
                    {% set next_date = oil_status.next_due_date | default(None) %}
                    <div class="oil-vehicle-card" data-vehicle="{{ vehicle.name }}" data-date="{{ vehicle_data.latest_date_str or '1900-01-01' }}" data-mileage="{{ vehicle_data.latest_mileage }}">
                        <div class="vehicle-header d-flex align-items-center gap-2"
                             role="button"
                             tabindex="0"
                             aria-controls="oil-card-{{ vehicle.id }}"
                             aria-expanded="false"
                             data-target="oil-card-{{ vehicle.id }}">
                            <i class="fa-solid fa-car oil-status-icon {{ status_class }}" aria-hidden="true"></i>
                            <div class="d-flex flex-column">
                                <div class="vehicle-title">
                                    {% if vehicle.year and vehicle.make and vehicle.model %}
                                        {{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}
                                    {% else %}
                                        {{ vehicle.name }}
                                    {% endif %}
                                </div>
                                {% if vehicle.name and (not vehicle.year or not vehicle.make or not vehicle.model) %}
                                    <span class="text-muted small">{{ vehicle.name }}</span>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1"></div>
                            <div class="d-flex align-items-center gap-2">
                                {% if vehicle_data.analysis_status == 'linked' %}
                                    <span class="analysis-status analysis-linked">
                                        <span class="icon-row">
                                            <i class="fa-solid fa-link icon-xs icon-base"></i>
                                            <span>Analysis Linked</span>
                                        </span>
                                    </span>
                                {% elif vehicle_data.analysis_status == 'available' %}
                                    <span class="analysis-status analysis-available">
                                        <span class="icon-row">
                                            <i class="fa-solid fa-flask icon-xs icon-base"></i>
                                            <span>Analysis Available</span>
                                        </span>
                                    </span>
                                {% else %}
                                    <span class="analysis-status analysis-none">
                                        <span class="icon-row">
                                            <i class="fa-solid fa-xmark icon-xs icon-base"></i>
                                            <span>No Analysis</span>
                                        </span>
                                    </span>
                                {% endif %}
                                <i class="fa-solid fa-chevron-down expand-icon text-muted ms-1" aria-hidden="true"></i>
                            </div>
                        </div>

                        <span id="oil-summary-{{ vehicle.id }}" class="visually-hidden">
                            Oil status for {{ vehicle.name }}. Current mileage:
                            {% if current_miles is not none %}
                                {{ '{:,}'.format(current_miles) }}
                            {% else %}
                                not available
                            {% endif %}.
                            Last change:
                            {{ last_change or 'not recorded' }}.
                            Next due:
                            {% if next_miles is not none %}
                                {{ '{:,}'.format(next_miles) }} miles{% if next_date %} on {{ next_date }}{% endif %}
                            {% elif next_date %}
                                {{ next_date }}
                            {% else %}
                                not scheduled
                            {% endif %}.
                        </span>

                        <div class="oil-summary-banner {{ status_class }}" role="group" aria-label="Oil summary" aria-describedby="oil-summary-{{ vehicle.id }}">
                            <i class="fa-solid fa-location-dot" aria-hidden="true"></i>
                            <span class="current">
                                Current:
                                {% if current_miles is not none %}
                                    {{ '{:,}'.format(current_miles) }} mi
                                {% else %}
                                    —
                                {% endif %}
                            </span>
                            <span class="separator">•</span>
                            <i class="fa-solid fa-droplet" aria-hidden="true"></i>
                            <span class="last">
                                Last Change: {{ last_change or '—' }}
                            </span>
                            <span class="separator">•</span>
                            <i class="fa-solid fa-clock" aria-hidden="true"></i>
                            <span class="next">
                                Next Due:
                                {% if next_miles is not none %}
                                    {{ '{:,}'.format(next_miles) }} mi
                                {% endif %}
                                {% if next_date %}
                                    {% if next_miles is not none %}
                                        ({{ next_date }})
                                    {% else %}
                                        {{ next_date }}
                                    {% endif %}
                                {% endif %}
                                {% if next_miles is none and not next_date %}
                                    —
                                {% endif %}
                            </span>
                        </div>

                        <div id="oil-card-{{ vehicle.id }}" class="oil-vehicle-content">
                            <div class="oil-card">
                                <div class="oil-card-header d-flex align-items-center justify-content-between">
                                    <div class="h6 m-0 d-flex align-items-center gap-2">
                                        <i class="fa-solid fa-droplet" aria-hidden="true"></i>
                                        <span>Recent Oil Changes</span>
                                    </div>
                                    <button type="button" class="btn-icon is-primary" onclick="openOilChangeModal({{ vehicle.id }}, '{{ vehicle.name }}')" aria-label="Add oil change for {{ vehicle.name }}">
                                        <i class="fa-solid fa-plus" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <div class="oil-card-body">
                                    {% if vehicle_data.oil_changes %}
                                        {% for oil_change in vehicle_data.oil_changes[:3] %}
                                        <div class="oil-detail-row">
                                            <div class="row align-items-center">
                                                <div class="col-md-6">
                                                    <strong>{% if oil_change.mileage is not none %}{{ '{:,}'.format(oil_change.mileage) }} miles{% else %}<span class="text-muted">—</span>{% endif %}</strong>
                                                    <small class="text-muted d-block">{{ oil_change.date.strftime('%m/%d/%Y') }}</small>
                                                </div>
                                                <div class="col-md-4">
                                                    <span class="text-muted">{{ oil_change.oil_type or 'Unknown' }} {{ oil_change.oil_brand or '' }}</span>
                                                    {% if oil_change.cost %}<small class="d-block">${{ "%.2f"|format(oil_change.cost) }}</small>{% endif %}
                                                </div>
                                                <div class="col-md-2 text-end">
                                                    <button class="btn btn-outline-primary btn-sm" onclick="editOilChange({{ oil_change.id }})" aria-label="Edit oil change">
                                                        <i class="fa-solid fa-pen-to-square fa-fw" aria-hidden="true"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                        {% if vehicle_data.oil_changes|length > 3 %}
                                        <div class="text-center mt-2">
                                            <small class="text-muted">... and {{ vehicle_data.oil_changes|length - 3 }} more</small>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="text-center text-muted py-3">
                                            <span class="icon-row">
                                                <i class="fa-solid fa-circle-info icon-s icon-base" aria-hidden="true"></i>
                                                <span>No oil changes recorded</span>
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <hr class="section-divider"/>

                            <div class="oil-card">
                                <div class="oil-card-header d-flex align-items-center justify-content-between">
                                    <div class="h6 m-0 d-flex align-items-center gap-2">
                                        <i class="fa-solid fa-calendar-check" aria-hidden="true"></i>
                                        <span>Upcoming Oil Changes</span>
                                    </div>
                                </div>
                                <div class="oil-card-body">
                                    {% if vehicle_data.future_oil_changes %}
                                        {% for future_oil_change in vehicle_data.future_oil_changes %}
                                        <div class="oil-detail-row border border-success border-opacity-25 bg-light">
                                            <div class="row align-items-center">
                                                <div class="col-md-6">
                                                    <strong class="text-success">{% if future_oil_change.target_mileage is not none %}{{ '{:,}'.format(future_oil_change.target_mileage) }} miles{% else %}<span class="text-muted">—</span>{% endif %}</strong>
                                                    <small class="text-muted d-block">{{ future_oil_change.target_date.strftime('%m/%d/%Y') if future_oil_change.target_date else 'Date TBD' }}</small>
                                                    {% if future_oil_change.notes %}
                                                    <small class="text-muted d-block">{{ future_oil_change.notes }}</small>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3">
                                                    {% if future_oil_change.estimated_cost %}
                                                    <span class="text-success fw-semibold">${{ '{:.2f}'.format(future_oil_change.estimated_cost) }}</span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-3 text-end">
                                                    <button class="btn btn-success btn-sm" onclick="completeOilChange({{ future_oil_change.id }}, {{ vehicle.id }}, '{{ vehicle.name }}')" aria-label="Complete scheduled oil change">
                                                        <span class="icon-row-sm">
                                                            <i class="fa-solid fa-check icon-m icon-base" aria-hidden="true"></i>
                                                            <span>Complete</span>
                                                        </span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center text-muted py-3">
                                            <span class="icon-row">
                                                <i class="fa-solid fa-circle-info icon-s icon-base" aria-hidden="true"></i>
                                                <span>No upcoming oil changes</span>
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <hr class="section-divider"/>

                            <div class="oil-card">
                                <div class="oil-card-header d-flex align-items-center justify-content-between">
                                    <div class="h6 m-0 d-flex align-items-center gap-2">
                                        <i class="fa-solid fa-flask-vial" aria-hidden="true"></i>
                                        <span>Oil Analysis</span>
                                    </div>
                                    <button type="button" class="btn-icon is-success" onclick="openAnalysisModal({{ vehicle.id }}, '{{ vehicle.name }}')" aria-label="Add oil analysis for {{ vehicle.name }}">
                                        <i class="fa-solid fa-plus" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <div class="oil-card-body">
                                    {% if vehicle_data.oil_analysis %}
                                        {% for analysis in vehicle_data.oil_analysis[:2] %}
                                        <div class="oil-detail-row">
                                            <div class="row align-items-center">
                                                <div class="col-md-6">
                                                    <strong>{% if analysis.mileage is not none %}{{ '{:,}'.format(analysis.mileage) }} miles{% else %}<span class="text-muted">—</span>{% endif %}</strong>
                                                    <small class="text-muted d-block">Sample: {{ analysis.date.strftime('%m/%d/%Y') }}</small>
                                                </div>
                                                <div class="col-md-4">
                                                    {% if analysis.oil_analysis_report %}
                                                        <a href="/oil-analysis/pdf/{{ analysis.id }}" target="_blank" class="badge bg-primary text-decoration-none icon-row">
                                                            <i class="fa-solid fa-file-pdf icon-xs icon-base" aria-hidden="true"></i>
                                                            <span>View PDF</span>
                                                        </a>
                                                    {% endif %}
                                                    {% set matching_oil_change = None %}
                                                    {% for oil_change in vehicle_data.oil_changes %}
                                                        {% if oil_change.mileage == analysis.mileage %}
                                                            {% set matching_oil_change = oil_change %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if matching_oil_change %}
                                                        <small class="d-block text-success icon-row">
                                                            <i class="fa-solid fa-link icon-xs icon-base" aria-hidden="true"></i>
                                                            <span>Linked to oil change</span>
                                                        </small>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-2 text-end">
                                                    <button class="btn btn-outline-success btn-sm" onclick="editAnalysis({{ analysis.id }})" aria-label="Edit oil analysis">
                                                        <i class="fa-solid fa-pen-to-square fa-fw" aria-hidden="true"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center text-muted py-3">
                                            <span class="icon-row">
                                                <i class="fa-solid fa-circle-info icon-s icon-base" aria-hidden="true"></i>
                                                <span>No analysis reports</span>
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Empty State -->
                {% if not vehicles_oil_data %}
                <div class="text-center py-5">
                    <i class="fa-solid fa-oil-can icon-xl icon-base text-muted mb-3"></i>
                    <h4 class="text-muted">No Oil Change Data</h4>
                    <p class="text-muted">Start by adding vehicles and their oil change records.</p>
                    <a href="/vehicles" class="btn btn-primary">
                        <span class="icon-row-sm">
                            <i class="fa-solid fa-circle-plus icon-m icon-base"></i>
                            <span>Add Vehicles</span>
                        </span>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% set oil_modal_vehicle_options = namespace(items=[]) %}
    {% for vehicle_data in vehicles_oil_data %}
        {% set modal_vehicle = vehicle_data.vehicle %}
        {% if modal_vehicle.year and modal_vehicle.make and modal_vehicle.model %}
            {% set modal_label = modal_vehicle.year ~ " " ~ modal_vehicle.make ~ " " ~ modal_vehicle.model %}
        {% else %}
            {% set modal_label = modal_vehicle.name %}
        {% endif %}
        {% set oil_modal_vehicle_options.items = oil_modal_vehicle_options.items + [(modal_vehicle.id, modal_label)] %}
    {% endfor %}
    {% set oil_modal_vehicle_options = oil_modal_vehicle_options.items %}

    <!-- Add Oil Change Modal -->
    <div class="modal fade" id="addOilChangeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="icon-row">
                            <i class="fa-solid fa-oil-can icon-m icon-base"></i>
                            <span>Add Oil Change - <span id="oilChangeVehicleName"></span></span>
                        </span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addOilChangeForm" onsubmit="submitOilChange(event)" method="post" action="/maintenance" enctype="multipart/form-data" data-enhanced-form="true" data-draft-key="oil-change-modal">
                    <div class="modal-body">
                        {% set form_errors = {} %}
                        {% set form_values = {} %}
                        {% set vehicle_options = oil_modal_vehicle_options %}
                        {% set id_prefix = 'om_' %}
                        {% include "partials/forms/oil_change_form.html" %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <span class="icon-row-sm">
                                <i class="fa-solid fa-xmark icon-m icon-base"></i>
                                <span>Cancel</span>
                            </span>
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-floppy-disk fa-fw icon-left" aria-hidden="true"></i>
                            <span>Add Oil Change</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Oil Analysis Modal -->
    <div class="modal fade" id="addAnalysisModal" tabindex="-1">
        <div class="modal-dialog modal-lg-custom">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="icon-row">
                            <i class="fa-solid fa-flask icon-m icon-base"></i>
                            <span>Add Oil Analysis - <span id="analysisVehicleName"></span></span>
                        </span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addAnalysisForm" onsubmit="submitAnalysis(event)" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" id="analysisVehicleId" name="vehicle_id">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Sample Mileage *</label>
                                    <input type="number" class="form-control" id="analysisMileage" name="mileage" required min="0" step="1" oninput="checkOilChangeMatch()">
                                    <div class="form-text">Mileage when oil sample was taken</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Sample Date *</label>
                                    <input type="text" class="form-control" name="date_str" required placeholder="MM/DD/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}">
                                    <div class="form-text">Date when sample was taken</div>
                                </div>
                            </div>
                        </div>

                        <!-- Smart Oil Change Detection -->
                        <div id="smartDetection" class="smart-detection" style="display: none;">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fa-solid fa-lightbulb icon-m icon-base text-warning"></i>
                                <div class="flex-grow-1">
                                    <strong>Smart Detection:</strong>
                                    <span id="detectionMessage"></span>
                                </div>
                                <div class="ms-3 d-flex gap-2">
                                    <button type="button" class="btn btn-success btn-sm" id="linkYesBtn" onclick="setLinking(true)">
                                        <span class="icon-row-sm">
                                            <i class="fa-solid fa-link icon-m icon-base"></i>
                                            <span>Yes, Link</span>
                                        </span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="linkNoBtn" onclick="setLinking(false)">
                                        <span class="icon-row-sm">
                                            <i class="fa-solid fa-link-slash icon-m icon-base"></i>
                                            <span>Standalone</span>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Analysis Description</label>
                            <textarea class="form-control" name="description" rows="2" placeholder="Brief description (e.g., 'Oil analysis from Blackstone Labs')"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <span class="icon-row">
                                    <i class="fa-solid fa-file-pdf icon-s icon-base"></i>
                                    <span>Analysis Report (PDF)</span>
                                </span>
                            </label>
                            <input type="file" class="form-control" name="oil_analysis_report" accept=".pdf">
                            <div class="form-text icon-row">
                                <i class="fa-solid fa-circle-info icon-xs icon-base"></i>
                                <span>Upload your oil analysis report from Blackstone Labs or other testing facilities</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Analysis Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" name="oil_analysis_cost" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Results Date</label>
                                    <input type="text" class="form-control" name="oil_analysis_date" placeholder="MM/DD/YYYY" pattern="\d{1,2}/\d{1,2}/\d{4}">
                                    <div class="form-text">Date when results were received</div>
                                </div>
                            </div>
                        </div>

                        <!-- Oil Analysis Results Section -->
                        <div class="mb-3">
                            <h6 class="text-info mb-3 d-flex align-items-center gap-2">
                                <i class="fa-solid fa-microscope icon-s icon-base"></i>
                                <span>Analysis Results (Optional)</span>
                            </h6>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Iron Level (ppm)</label>
                                    <input type="number" class="form-control" name="iron_level" step="0.1" min="0" placeholder="e.g., 12.5">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Aluminum Level (ppm)</label>
                                    <input type="number" class="form-control" name="aluminum_level" step="0.1" min="0" placeholder="e.g., 8.2">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Copper Level (ppm)</label>
                                    <input type="number" class="form-control" name="copper_level" step="0.1" min="0" placeholder="e.g., 3.1">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Viscosity (cSt)</label>
                                    <input type="number" class="form-control" name="viscosity" step="0.1" min="0" placeholder="e.g., 95.2">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">TBN</label>
                                    <input type="number" class="form-control" name="tbn" step="0.1" min="0" placeholder="e.g., 7.8">
                                    <div class="form-text">Total Base Number</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Fuel Dilution (%)</label>
                                    <input type="number" class="form-control" name="fuel_dilution" step="0.1" min="0" max="100" placeholder="e.g., 2.1">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Driving Conditions</label>
                                    <select class="form-select" name="driving_conditions">
                                        <option value="">Select condition...</option>
                                        <option value="Normal">Normal</option>
                                        <option value="Severe">Severe</option>
                                        <option value="Highway">Mostly Highway</option>
                                        <option value="City">Mostly City</option>
                                        <option value="Mixed">Mixed</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" name="coolant_contamination" id="coolantContamination">
                                        <label class="form-check-label" for="coolantContamination">
                                            Coolant Contamination Detected
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-control" name="oil_consumption_notes" rows="2" placeholder="Any additional observations or notes"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <span class="icon-row-sm">
                                <i class="fa-solid fa-xmark icon-m icon-base"></i>
                                <span>Cancel</span>
                            </span>
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fa-solid fa-floppy-disk fa-fw icon-left" aria-hidden="true"></i>
                            <span>Add Oil Analysis</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/forms.js?v=1"></script>
    
    <script>
        // Global variables
        let vehiclesData = {{ vehicles_json_data | tojson }};
        let mostRecentVehicleId = {{ most_recent_vehicle_id or 'null' }};
        let currentVehicleId = null;
        let currentVehicleOilChanges = [];
        let linkToOilChange = false;
        let matchedOilChange = null;

        function resolveVehicleName(vehicleId) {
            if (!vehicleId || !Array.isArray(vehiclesData)) {
                return "";
            }
            const match = vehiclesData.find((entry) => String(entry.vehicle.id) === String(vehicleId));
            return match ? match.vehicle.name : "";
        }

        // Card expansion functionality
        function toggleCard(header) {
            if (!header) {
                return;
            }

            const card = header.closest('.oil-vehicle-card');
            if (!card) {
                return;
            }

            const targetId = header.getAttribute('data-target');
            const content = targetId ? document.getElementById(targetId) : card.querySelector('.oil-vehicle-content');
            const icon = header.querySelector('.expand-icon') || card.querySelector('.expand-icon');
            const isExpanded = header.getAttribute('aria-expanded') === 'true';

            if (isExpanded) {
                header.setAttribute('aria-expanded', 'false');
                if (content) {
                    content.classList.remove('show');
                }
                if (icon) {
                    icon.classList.remove('rotated');
                }
                card.classList.remove('expanded');
                return;
            }

            document.querySelectorAll('.vehicle-header[role="button"]').forEach(otherHeader => {
                otherHeader.setAttribute('aria-expanded', 'false');
            });

            document.querySelectorAll('.oil-vehicle-content').forEach(section => {
                section.classList.remove('show');
            });

            document.querySelectorAll('.oil-vehicle-card').forEach(otherCard => {
                otherCard.classList.remove('expanded');
            });

            document.querySelectorAll('.oil-vehicle-card .expand-icon').forEach(otherIcon => {
                otherIcon.classList.remove('rotated');
            });

            header.setAttribute('aria-expanded', 'true');
            if (content) {
                content.classList.add('show');
            }
            if (icon) {
                icon.classList.add('rotated');
            }
            card.classList.add('expanded');
        }

        document.addEventListener('click', (event) => {
            const header = event.target.closest('.vehicle-header[role="button"]');
            if (!header || event.target.closest('a, button, input, select, textarea')) {
                return;
            }
            toggleCard(header);
        });

        document.addEventListener('keydown', (event) => {
            const header = event.target.closest('.vehicle-header[role="button"]');
            if (!header) {
                return;
            }
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleCard(header);
            }
        });

        // Sorting functionality
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Sort cards
                sortCards(this.dataset.sort);
            });
        });

        function sortCards(sortType) {
            const container = document.getElementById('oilCardsContainer');
            const cards = Array.from(container.querySelectorAll('.oil-vehicle-card'));
            
            cards.sort((a, b) => {
                switch(sortType) {
                    case 'vehicle-az':
                        return a.dataset.vehicle.localeCompare(b.dataset.vehicle);
                    case 'vehicle-za':
                        return b.dataset.vehicle.localeCompare(a.dataset.vehicle);
                    case 'date-recent':
                        return new Date(b.dataset.date || '1900-01-01') - new Date(a.dataset.date || '1900-01-01');
                    case 'date-past':
                        return new Date(a.dataset.date || '1900-01-01') - new Date(b.dataset.date || '1900-01-01');
                    case 'mileage-high':
                        return parseInt(b.dataset.mileage) - parseInt(a.dataset.mileage);
                    case 'mileage-low':
                        return parseInt(a.dataset.mileage) - parseInt(b.dataset.mileage);
                    default:
                        return 0;
                }
            });
            
            // Reorder DOM elements
            cards.forEach(card => container.appendChild(card));
        }

        // Modal functions
        function openOilChangeModal(vehicleId, vehicleName = "", futureMaintenanceId = null) {
            const modalEl = document.getElementById('addOilChangeModal');
            if (!modalEl || !window.bootstrap || !bootstrap.Modal) {
                return false;
            }

            const form = document.getElementById('addOilChangeForm');
            if (form) {
                form.reset();
            }

            const resolvedVehicleId = vehicleId ?? mostRecentVehicleId ?? "";
            const vehicleSelect = modalEl.querySelector('#om_vehicle_id');
            if (vehicleSelect) {
                vehicleSelect.value = resolvedVehicleId ?? "";
                vehicleSelect.dispatchEvent(new Event('change', { bubbles: true }));
            }

            const hiddenFutureInput = modalEl.querySelector('#om_future_maintenance_id');
            if (hiddenFutureInput) {
                hiddenFutureInput.value = futureMaintenanceId ?? "";
            }

            const headerName = modalEl.querySelector('#oilChangeVehicleName');
            if (headerName) {
                const resolvedName =
                    vehicleName ||
                    resolveVehicleName(resolvedVehicleId) ||
                    "";
                headerName.textContent = resolvedName || 'Select Vehicle';
            }

            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            modalInstance.show();

            const focusTarget = modalEl.querySelector('input[name="mileage"]');
            if (focusTarget) {
                setTimeout(() => focusTarget.focus(), 120);
            }

            return true;
        }

        function openAnalysisModal(vehicleId, vehicleName) {
            currentVehicleId = vehicleId;
            document.getElementById('analysisVehicleId').value = vehicleId;
            document.getElementById('analysisVehicleName').textContent = vehicleName;
            
            // Get oil changes for this vehicle
            const vehicleData = vehiclesData.find(v => v.vehicle.id === vehicleId);
            currentVehicleOilChanges = vehicleData && vehicleData.oil_changes ? vehicleData.oil_changes : [];
            
            // Set current date as default
            const today = new Date();
            const dateStr = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                           today.getDate().toString().padStart(2, '0') + '/' + 
                           today.getFullYear();
            document.querySelector('#addAnalysisModal input[name="date_str"]').value = dateStr;
            
            // Reset form
            document.getElementById('smartDetection').style.display = 'none';
            linkToOilChange = false;
            matchedOilChange = null;
            
            new bootstrap.Modal(document.getElementById('addAnalysisModal')).show();
        }

        // Smart oil change detection
        function checkOilChangeMatch() {
            const mileage = parseInt(document.getElementById('analysisMileage').value);
            const detection = document.getElementById('smartDetection');
            const message = document.getElementById('detectionMessage');
            
            if (!mileage || !currentVehicleOilChanges.length) {
                detection.style.display = 'none';
                return;
            }
            
            // Find exact mileage match
            matchedOilChange = currentVehicleOilChanges.find(oc => parseInt(oc.mileage) === mileage);
            
            if (matchedOilChange) {
                detection.style.display = 'block';
                detection.classList.add('found');
                message.innerHTML = `Found oil change at <strong>${mileage.toLocaleString()}</strong> miles on <strong>${new Date(matchedOilChange.date).toLocaleDateString()}</strong>. Link to it?`;
            } else {
                detection.style.display = 'none';
                detection.classList.remove('found');
                linkToOilChange = false;
                matchedOilChange = null;
            }
        }

        function setLinking(shouldLink) {
            linkToOilChange = shouldLink;
            const yesBtn = document.getElementById('linkYesBtn');
            const noBtn = document.getElementById('linkNoBtn');
            
            if (shouldLink) {
                yesBtn.classList.remove('btn-success');
                yesBtn.classList.add('btn-success');
                noBtn.classList.remove('btn-outline-secondary');
                noBtn.classList.add('btn-outline-secondary');
            } else {
                yesBtn.classList.remove('btn-success');
                yesBtn.classList.add('btn-outline-success');
                noBtn.classList.remove('btn-outline-secondary');
                noBtn.classList.add('btn-secondary');
            }
        }

        // Form submissions
        function submitOilChange(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            // Ensure vehicle_id is set
            const vehicleSelect = form.querySelector('select[name="vehicle_id"]');
            const vehicleId = vehicleSelect ? vehicleSelect.value : "";
            console.log('Oil Change Vehicle ID:', vehicleId);
            if (!vehicleId) {
                alert('Vehicle ID is missing. Please close the modal and try again.');
                return;
            }
            
            // Ensure date_str is set
            if (!formData.get('date_str')) {
                const today = new Date();
                const dateStr = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                               today.getDate().toString().padStart(2, '0') + '/' + 
                               today.getFullYear();
                formData.set('date_str', dateStr);
            }
            
            // Debug: log all form data
            console.log('Form data being sent:');
            for (let [key, value] of formData.entries()) {
                console.log(key, ':', value);
            }
            
            // Add required fields
            formData.append('is_oil_change', 'true');
            formData.append('form_type', 'oil_change');
            if (!formData.get('description')) {
                const oilType = formData.get('oil_type') || 'Unknown';
                const oilBrand = formData.get('oil_brand') || '';
                formData.set('description', `Oil change - ${oilType} ${oilBrand}`.trim());
            }
            
            fetch('/maintenance', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Close modal and reload page to stay on oil management
                    bootstrap.Modal.getInstance(document.getElementById('addOilChangeModal')).hide();
                    window.location.href = '/oil-management';
                } else {
                    throw new Error('Failed to add oil change');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add oil change. Please try again.');
            });
        }

        function submitAnalysis(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            // Ensure vehicle_id is set
            const vehicleId = document.getElementById('analysisVehicleId').value;
            console.log('Analysis Vehicle ID:', vehicleId);
            if (!vehicleId) {
                alert('Vehicle ID is missing. Please close the modal and try again.');
                return;
            }
            formData.set('vehicle_id', vehicleId);
            
            // Ensure date_str is set
            if (!formData.get('date_str')) {
                const today = new Date();
                const dateStr = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                               today.getDate().toString().padStart(2, '0') + '/' + 
                               today.getFullYear();
                formData.set('date_str', dateStr);
            }
            
            // Debug: log all form data
            console.log('Form data being sent:');
            for (let [key, value] of formData.entries()) {
                console.log(key, ':', value);
            }
            
            // Set description if empty
            if (!formData.get('description')) {
                const mileage = formData.get('mileage');
                formData.set('description', `Oil Analysis - ${parseInt(mileage).toLocaleString()} miles`);
            }
            
            // Add oil analysis marker and form type
            formData.append('oil_analysis_date', formData.get('date_str'));
            formData.append('form_type', 'oil_analysis');
            
            fetch('/maintenance', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Close modal and reload page to stay on oil management
                    bootstrap.Modal.getInstance(document.getElementById('addAnalysisModal')).hide();
                    window.location.href = '/oil-management';
                } else {
                    throw new Error('Failed to add analysis');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to add oil analysis. Please try again.');
            });
        }

        // Edit functions
        function editOilChange(recordId) {
            window.location.href = `/maintenance/${recordId}/edit?return_url=/oil-management`;
        }

        function editAnalysis(recordId) {
            // Use the maintenance form which now properly handles oil analysis records
            window.location.href = `/maintenance/${recordId}/edit?return_url=/oil-management`;
        }

        function completeOilChange(futureMaintenanceId, vehicleId, vehicleName) {
            const url = new URL('/oil-management', window.location.origin);
            url.searchParams.set('open', 'add-oil');
            if (vehicleId) {
                url.searchParams.set('vehicleId', vehicleId);
            }
            if (futureMaintenanceId) {
                url.searchParams.set('futureMaintenanceId', futureMaintenanceId);
            }
            const currentAccountId = new URLSearchParams(window.location.search).get('accountId');
            if (currentAccountId) {
                url.searchParams.set('accountId', currentAccountId);
            }
            window.location.href = url.toString();
        }

    </script>

    <script>
    // Belt-and-suspenders auto-open script: robust handling of open=add-oil parameter
    (function() {
        'use strict';
        
        // Wait for DOM to be ready
        const readyCheck = (callback) => {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                callback();
            }
        };

        readyCheck(function() {
            try {
                const url = new URL(window.location.href);
                const openParam = url.searchParams.get('open');
                
                // Only proceed if open=add-oil is explicitly present
                if (!openParam || openParam.toLowerCase() !== 'add-oil') {
                    return;
                }

                // Extract parameters
                const vehicleId = url.searchParams.get('vehicleId') || '';
                const futureId = 
                    url.searchParams.get('futureMaintenanceId') || 
                    url.searchParams.get('future_maintenance_id') || 
                    '';

                // Robust attempt function that checks for all prerequisites
                const attemptOpen = () => {
                    // Check 1: openOilChangeModal function exists
                    if (typeof openOilChangeModal !== 'function') {
                        return false;
                    }
                    
                    // Check 2: Bootstrap is loaded and Modal class exists
                    if (!window.bootstrap || !bootstrap.Modal) {
                        return false;
                    }
                    
                    // Check 3: Modal element exists in DOM
                    const modalEl = document.getElementById('addOilChangeModal');
                    if (!modalEl) {
                        return false;
                    }
                    
                    // All prerequisites met - attempt to open
                    try {
                        const opened = openOilChangeModal(vehicleId, "", futureId);
                        
                        if (opened) {
                            // Clean URL after successful open
                            url.searchParams.delete('open');
                            if (!vehicleId) {
                                url.searchParams.delete('vehicleId');
                            }
                            if (!futureId) {
                                url.searchParams.delete('futureMaintenanceId');
                                url.searchParams.delete('future_maintenance_id');
                            }
                            const newUrl = url.pathname + (url.searchParams.toString() ? '?' + url.searchParams.toString() : '');
                            history.replaceState({}, '', newUrl);
                        }
                        
                        return opened;
                    } catch (err) {
                        console.error('Error calling openOilChangeModal:', err);
                        return false;
                    }
                };

                // Try immediately first
                if (attemptOpen()) {
                    return; // Success!
                }

                // If not ready, retry with exponential backoff up to 3 seconds
                let tries = 0;
                const maxTries = 30; // 30 * 100ms = 3 seconds max wait
                const retryInterval = setInterval(() => {
                    tries += 1;
                    if (attemptOpen() || tries >= maxTries) {
                        clearInterval(retryInterval);
                        if (tries >= maxTries && !attemptOpen()) {
                            console.warn('Auto-open failed: openOilChangeModal not available after 3 seconds. URL param open=add-oil may need manual action.');
                        }
                    }
                }, 100);
                
            } catch (err) {
                console.error('Error in auto-open add-oil script:', err);
            }
        });
    })();
    </script>
</body>
</html>
