<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if record %}Edit{% else %}Add{% endif %} {% if form_type == "oil_analysis" %}Oil Analysis{% elif form_type == "oil_change" %}Oil Change{% else %}Maintenance{% endif %} - Vehicle Maintenance Tracker</title>
    {% include 'partials/head_resources.html' %}
    <style>
        .form-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Button styles are now centralized in app-styles.css */
        .nav-link {
            color: #6c757d;
            font-weight: 500;
        }
        .nav-link:hover {
            color: #495057;
        }
        .nav-link.active {
            color: #007bff !important;
            font-weight: 600;
        }
        .dropdown-item {
            color: #6c757d;
        }
        .dropdown-item:hover {
            color: #495057;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body class="bg-light">
    {% include 'nav.html' %}

    <div class="container mt-4">
                    <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card form-card" style="background-color: #f8f9fa; border: 2px solid #dee2e6 !important;">
                        <div class="card-header bg-primary text-white text-center py-3">
                        <h4 class="mb-0">
                            {% if form_type == "oil_analysis" %}
                                <i class="fa-solid fa-flask me-2"></i>
                                {% if record %}Edit Oil Analysis{% else %}Add New Oil Analysis{% endif %}
                            {% elif form_type == "oil_change" %}
                                <i class="fa-solid fa-oil-can me-2"></i>
                                {% if record %}Edit Oil Change{% else %}Add New Oil Change{% endif %}
                            {% else %}
                                <i class="fa-solid fa-screwdriver-wrench me-2"></i>
                                {% if record %}Edit Maintenance Record{% else %}Add New Maintenance Record{% endif %}
                            {% endif %}
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        {% from "partials/forms/macros.html" import field, text_input, select_input, number_input, money_input, date_input, textarea, checkbox, field_error %}
                        {% set form_values = form if form is defined and form is not none else {} %}
                        {% set form_errors = errors if errors is defined and errors is not none else {} %}
                        {% set selected_vehicle_id = form_values.get("vehicle_id", selected_vehicle_id) %}
                        {% set vehicle_options = namespace(items=[]) %}
                        {% for vehicle in vehicles %}
                            {% set option_label = vehicle.name %}
                            {% if vehicle.year %}
                                {% set option_label = option_label ~ " - " ~ vehicle.year ~ " " ~ vehicle.make ~ " " ~ vehicle.model %}
                            {% endif %}
                            {% set vehicle_options.items = vehicle_options.items + [(vehicle.id, option_label)] %}
                        {% endfor %}

                        {% if not form_type or form_type == "maintenance" %}
                        <!-- Oil change notice for regular maintenance records -->
                        <div class="alert alert-info mb-4" role="alert">
                            <i class="fa-solid fa-circle-info me-2"></i>
                            <strong>Note:</strong> Oil changes should be entered on the <a href="/oil-management" class="alert-link">Oil Management</a> page.
                        </div>
                        {% endif %}

                        {% if record %}
                        <!-- Show vehicle info for existing records -->
                        <div class="mb-4 p-3 bg-light rounded">
                            <h6 class="d-flex align-items-center gap-2"><i class="fa-solid fa-car icon-s icon-base"></i><span>Vehicle Information</span></h6>
                            <p class="mb-0">
                                <strong>{{ record.vehicle.name }}</strong> - {{ record.vehicle.year }} {{ record.vehicle.make }} {{ record.vehicle.model }}
                                {% if record.vehicle.vin %}
                                <br><small class="text-muted">VIN: {{ record.vehicle.vin }}</small>
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}

                        {% if form_errors %}
                        <div class="mb-3 rounded-3 border border-2 border-danger-subtle bg-danger-subtle text-danger-emphasis p-3" role="alert">
                            <span class="icon-row">
                                <i class="fa-solid fa-triangle-exclamation icon-m icon-base"></i>
                                <span>Please fix the highlighted fields below.</span>
                            </span>
                        </div>
                        {% endif %}

                        {% if form_type == "oil_change" and not record %}
                        <div class="alert alert-info d-flex align-items-center justify-content-between flex-wrap gap-2" role="alert">
                            <span>
                                <i class="fa-solid fa-circle-info me-2"></i>
                                Use the Oil Management page to add oil changes.
                            </span>
                            <a class="btn-action btn-action-primary"
                               href="/oil-management?open=add-oil{% if selected_vehicle_id %}&vehicleId={{ selected_vehicle_id }}{% endif %}">
                                <i class="fa-solid fa-oil-can" aria-hidden="true"></i>
                                <span>Add Oil Change</span>
                            </a>
                        </div>
                        {% else %}
                        <form method="post"
                              action="{% if record %}/maintenance/{{ record.id }}{% else %}/maintenance{% endif %}"
                              enctype="multipart/form-data"
                              data-account-aware="true"
                              data-enhanced-form="true"
                              data-draft-key="maintenance-form">
                            {% if return_url %}
                            <input type="hidden" name="return_url" value="{{ return_url }}">
                            {% endif %}
                            {% if future_maintenance_id %}
                            <input type="hidden" name="future_maintenance_id" value="{{ future_maintenance_id }}">
                            {% endif %}
                            
                            {% if not record %}
                                {% call field("vehicle_id", "Vehicle", required=True, error=field_error(form_errors, "vehicle_id")) %}
                                    {{ select_input(
                                        "vehicle_id",
                                        "vehicle_id",
                                        vehicle_options.items,
                                        value=selected_vehicle_id|default('', true),
                                        required=True,
                                        invalid=form_errors.get("vehicle_id"),
                                        attrs={"placeholder": "Select a vehicle..."}
                                    ) }}
                                {% endcall %}
                            {% else %}
                            <input type="hidden" name="vehicle_id" value="{{ record.vehicle_id }}">
                            {% endif %}

                            {% if form_type == "maintenance" %}
                                {% set maintenance_date_value = form_values.get("date_str") %}
                                {% if maintenance_date_value is none %}
                                    {% if record and record.date and record.date.year > 1900 %}
                                        {% set maintenance_date_value = record.date.strftime('%m/%d/%Y') %}
                                    {% elif pre_populated_data and pre_populated_data.target_date %}
                                        {% set maintenance_date_value = pre_populated_data.target_date.strftime('%m/%d/%Y') %}
                                    {% else %}
                                        {% set maintenance_date_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("date_str", "Date", help_text="Leave blank if date is unknown – record will use placeholder date (01/01/1900) and be sorted by mileage", error=field_error(form_errors, "date_str")) %}
                                    {{ date_input(
                                        "date_str",
                                        "date_str",
                                        value=maintenance_date_value|default('', true),
                                        invalid=form_errors.get("date_str"),
                                        attrs={
                                            "placeholder": "MM/DD/YYYY",
                                            "pattern": "\\d{1,2}/\\d{1,2}/\\d{4}",
                                            "data-date-max-today": ""
                                        }
                                    ) }}
                                {% endcall %}

                                {% set maintenance_mileage_value = form_values.get("mileage") %}
                                {% if maintenance_mileage_value is none %}
                                    {% if record and record.mileage is not none %}
                                        {% set maintenance_mileage_value = record.mileage %}
                                    {% elif pre_populated_data and pre_populated_data.target_mileage %}
                                        {% set maintenance_mileage_value = pre_populated_data.target_mileage %}
                                    {% else %}
                                        {% set maintenance_mileage_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("mileage", "Mileage", help_text="Leave blank if mileage is unknown – record will use placeholder mileage (0) and be sorted by date", error=field_error(form_errors, "mileage")) %}
                                    {{ number_input(
                                        "mileage",
                                        "mileage",
                                        value=maintenance_mileage_value|default('', true),
                                        step="1",
                                        min="0",
                                        invalid=form_errors.get("mileage"),
                                        attrs={
                                            "inputmode": "numeric",
                                            "data-mileage": "true"
                                        }
                                    ) }}
                                {% endcall %}

                                {% set maintenance_description_value = form_values.get("description") %}
                                {% if maintenance_description_value is none %}
                                    {% if record %}
                                        {% set maintenance_description_value = record.description %}
                                    {% elif pre_populated_data %}
                                        {% set maintenance_description_value = pre_populated_data.description %}
                                    {% else %}
                                        {% set maintenance_description_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("description", "Description", error=field_error(form_errors, "description")) %}
                                    {{ textarea(
                                        "description",
                                        "description",
                                        value=maintenance_description_value|default('', true),
                                        rows=3,
                                        placeholder="Describe the maintenance performed, parts replaced, or issues addressed..."
                                    ) }}
                                {% endcall %}

                                {% set maintenance_cost_value = form_values.get("cost") %}
                                {% if maintenance_cost_value is none %}
                                    {% if record and record.cost is not none %}
                                        {% set maintenance_cost_value = '%.2f'|format(record.cost) %}
                                    {% elif pre_populated_data and pre_populated_data.estimated_cost %}
                                        {% set maintenance_cost_value = '%.2f'|format(pre_populated_data.estimated_cost) %}
                                    {% else %}
                                        {% set maintenance_cost_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("cost", "Cost (Optional)", help_text="Enter the cost of parts, labor, or services. Leave blank if no cost.", error=field_error(form_errors, "cost")) %}
                                    {{ money_input(
                                        "cost",
                                        "cost",
                                        value=maintenance_cost_value|default('', true),
                                        invalid=form_errors.get("cost")
                                    ) }}
                                {% endcall %}

                                {% call field("photo", "Photo Documentation", error=field_error(form_errors, "photo")) %}
                                    <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
                                <div class="form-text">
                                        <i class="fa-solid fa-circle-info me-1"></i>
                                        Upload a photo of the work performed, parts replaced, or issues addressed
                                    </div>
                                    {% if record and record.photo_path %}
                                    <div class="mt-2">
                                        <img src="/{{ record.photo_path }}" alt="Maintenance photo" class="img-fluid rounded" style="max-width: 300px;">
                                        <div class="mt-1">
                                            <small class="text-muted">{{ record.photo_description or 'No description' }}</small>
                                </div>
                            </div>
                                    {% endif %}
                                {% endcall %}

                                {% set maintenance_photo_desc_value = form_values.get("photo_description") %}
                                {% if maintenance_photo_desc_value is none %}
                                    {% if record %}
                                        {% set maintenance_photo_desc_value = record.photo_description %}
                                    {% else %}
                                        {% set maintenance_photo_desc_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("photo_description", "Photo Description", error=field_error(form_errors, "photo_description")) %}
                                    {{ textarea(
                                        "photo_description",
                                        "photo_description",
                                        value=maintenance_photo_desc_value|default('', true),
                                        rows=2,
                                        placeholder="Describe what's shown in the photo"
                                    ) }}
                                {% endcall %}
                            {% endif %}

                            {% if form_type == "oil_change" %}
                                {% if record %}
                                    {% set vehicle_options_list = vehicle_options.items %}
                                    {% set vehicle_options = vehicle_options_list %}
                                    {% set id_prefix = 'edit_' %}
                                    {% include "partials/forms/oil_change_form.html" %}
                                {% endif %}
                            {% endif %}

                            {% if form_type == "oil_analysis" %}
                                {% set analysis_date_value = form_values.get("date_str") %}
                                {% if analysis_date_value is none %}
                                    {% if record and record.date and record.date.year > 1900 %}
                                        {% set analysis_date_value = record.date.strftime('%m/%d/%Y') %}
                                    {% else %}
                                        {% set analysis_date_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("date_str", "Analysis Sample Taken", required=True, error=field_error(form_errors, "date_str")) %}
                                    {{ date_input(
                                        "date_str",
                                        "date_str",
                                        value=analysis_date_value|default('', true),
                                        invalid=form_errors.get("date_str"),
                                        attrs={
                                            "placeholder": "MM/DD/YYYY",
                                            "pattern": "\\d{1,2}/\\d{1,2}/\\d{4}",
                                            "required": "required"
                                        }
                                    ) }}
                                {% endcall %}

                                {% set analysis_mileage_value = form_values.get("mileage") %}
                                {% if analysis_mileage_value is none %}
                                    {% if record %}
                                        {% set analysis_mileage_value = record.mileage %}
                                    {% else %}
                                        {% set analysis_mileage_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("analysis_mileage", "Mileage at Analysis Sample", required=True, error=field_error(form_errors, "mileage")) %}
                                    {{ number_input(
                                        "analysis_mileage",
                                        "mileage",
                                        value=analysis_mileage_value|default('', true),
                                        step="1",
                                        min="0",
                                        required=True,
                                        invalid=form_errors.get("mileage"),
                                        attrs={"placeholder": "e.g., 50000"}
                                    ) }}
                                {% endcall %}

                                {% set analysis_description_value = form_values.get("description") %}
                                {% if analysis_description_value is none %}
                                    {% if record %}
                                        {% set analysis_description_value = record.description %}
                                    {% else %}
                                        {% set analysis_description_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("analysis_description", "Analysis Description", error=field_error(form_errors, "description")) %}
                                    {{ textarea(
                                        "analysis_description",
                                        "description",
                                        value=analysis_description_value|default('', true),
                                        rows=2,
                                        placeholder="Brief description of the oil analysis (e.g., 'Oil analysis from Blackstone Labs')"
                                    ) }}
                                {% endcall %}

                                {% call field("oil_analysis_report", "Oil Analysis Report (PDF)", error=field_error(form_errors, "oil_analysis_report")) %}
                                    <input type="file" class="form-control" id="oil_analysis_report" name="oil_analysis_report" accept=".pdf">
                                    <div class="form-text">
                                        <i class="fa-solid fa-circle-info me-1"></i>
                                        Upload your oil analysis report from Blackstone Labs or other testing facilities
                                    </div>
                                    {% if record and record.oil_analysis_report %}
                                    <div class="mt-2">
                                        <a href="/oil-analysis/pdf/{{ record.id }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <span class="icon-row-sm">
                                                <i class="fa-solid fa-file-pdf icon-m icon-base"></i>
                                                <span>View Current PDF</span>
                                            </span>
                                        </a>
                                    </div>
                                    {% endif %}
                                {% endcall %}

                                {% set oil_analysis_date_value = form_values.get("oil_analysis_date") %}
                                {% if oil_analysis_date_value is none %}
                                    {% if record and record.oil_analysis_date %}
                                        {% set oil_analysis_date_value = record.oil_analysis_date.strftime('%m/%d/%Y') %}
                                    {% else %}
                                        {% set oil_analysis_date_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% set next_oil_analysis_date_value = form_values.get("next_oil_analysis_date") %}
                                {% if next_oil_analysis_date_value is none %}
                                    {% if record and record.next_oil_analysis_date %}
                                        {% set next_oil_analysis_date_value = record.next_oil_analysis_date.strftime('%m/%d/%Y') %}
                                    {% else %}
                                        {% set next_oil_analysis_date_value = "" %}
                                    {% endif %}
                                {% endif %}
                                <div class="row">
                                    <div class="col-md-6">
                                        {% call field("oil_analysis_date", "Analysis Results Date", error=field_error(form_errors, "oil_analysis_date")) %}
                                            {{ date_input(
                                                "oil_analysis_date",
                                                "oil_analysis_date",
                                                value=oil_analysis_date_value|default('', true),
                                                invalid=form_errors.get("oil_analysis_date"),
                                                attrs={"placeholder": "MM/DD/YYYY", "pattern": "\\d{1,2}/\\d{1,2}/\\d{4}"}
                                            ) }}
                                        {% endcall %}
                                    </div>
                                    <div class="col-md-6">
                                        {% call field("next_oil_analysis_date", "Next Analysis Due", error=field_error(form_errors, "next_oil_analysis_date")) %}
                                            {{ date_input(
                                                "next_oil_analysis_date",
                                                "next_oil_analysis_date",
                                                value=next_oil_analysis_date_value|default('', true),
                                                invalid=form_errors.get("next_oil_analysis_date"),
                                                attrs={"placeholder": "MM/DD/YYYY", "pattern": "\\d{1,2}/\\d{1,2}/\\d{4}"}
                                            ) }}
                                        {% endcall %}
                                    </div>
                                </div>

                                {% set oil_analysis_cost_value = form_values.get("oil_analysis_cost") %}
                                {% if oil_analysis_cost_value is none %}
                                    {% if record and record.oil_analysis_cost %}
                                        {% set oil_analysis_cost_value = '%.2f'|format(record.oil_analysis_cost) %}
                                    {% else %}
                                        {% set oil_analysis_cost_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("oil_analysis_cost", "Analysis Cost", error=field_error(form_errors, "oil_analysis_cost")) %}
                                    {{ money_input(
                                        "oil_analysis_cost",
                                        "oil_analysis_cost",
                                        value=oil_analysis_cost_value|default('', true),
                                        invalid=form_errors.get("oil_analysis_cost")
                                    ) }}
                                {% endcall %}

                                {% set total_analysis_cost_value = form_values.get("cost") %}
                                {% if total_analysis_cost_value is none %}
                                    {% if record and record.cost %}
                                        {% set total_analysis_cost_value = '%.2f'|format(record.cost) %}
                                    {% else %}
                                        {% set total_analysis_cost_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("analysis_total_cost", "Total Cost", error=field_error(form_errors, "cost")) %}
                                    {{ money_input(
                                        "cost",
                                        "cost",
                                        value=total_analysis_cost_value|default('', true),
                                        invalid=form_errors.get("cost")
                                    ) }}
                                {% endcall %}

                                <hr class="my-4">
                                <h6 class="text-info mb-3">
                                    <span class="icon-row">
                                        <i class="fa-solid fa-microscope icon-m icon-base"></i>
                                        <span>Analysis Results (Optional)</span>
                                    </span>
                                </h6>

                                <div class="row">
                                    <div class="col-md-4">
                                        {% call field("iron_level", "Iron Level (ppm)", error=field_error(form_errors, "iron_level")) %}
                                            {{ number_input(
                                                "iron_level",
                                                "iron_level",
                                                value=form_values.get("iron_level", record.iron_level if record else "")|default('', true),
                                                step="0.1",
                                                min="0",
                                                attrs={"placeholder": "e.g., 12.5"}
                                            ) }}
                                        {% endcall %}
                                    </div>
                                    <div class="col-md-4">
                                        {% call field("aluminum_level", "Aluminum Level (ppm)", error=field_error(form_errors, "aluminum_level")) %}
                                            {{ number_input(
                                                "aluminum_level",
                                                "aluminum_level",
                                                value=form_values.get("aluminum_level", record.aluminum_level if record else "")|default('', true),
                                                step="0.1",
                                                min="0",
                                                attrs={"placeholder": "e.g., 8.2"}
                                            ) }}
                                        {% endcall %}
                                    </div>
                                    <div class="col-md-4">
                                        {% call field("copper_level", "Copper Level (ppm)", error=field_error(form_errors, "copper_level")) %}
                                            {{ number_input(
                                                "copper_level",
                                                "copper_level",
                                                value=form_values.get("copper_level", record.copper_level if record else "")|default('', true),
                                                step="0.1",
                                                min="0",
                                                attrs={"placeholder": "e.g., 3.1"}
                                            ) }}
                                        {% endcall %}
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        {% call field("viscosity", "Viscosity (cSt)", error=field_error(form_errors, "viscosity")) %}
                                            {{ number_input(
                                                "viscosity",
                                                "viscosity",
                                                value=form_values.get("viscosity", record.viscosity if record else "")|default('', true),
                                                step="0.1",
                                                min="0",
                                                attrs={"placeholder": "e.g., 95.2"}
                                            ) }}
                                        {% endcall %}
                                    </div>
                                    <div class="col-md-4">
                                        {% call field("tbn", "TBN", error=field_error(form_errors, "tbn")) %}
                                            {{ number_input(
                                                "tbn",
                                                "tbn",
                                                value=form_values.get("tbn", record.tbn if record else "")|default('', true),
                                                step="0.1",
                                                min="0",
                                                attrs={"placeholder": "e.g., 7.8"}
                                            ) }}
                                        {% endcall %}
                                    </div>
                                    <div class="col-md-4">
                                        {% call field("fuel_dilution", "Fuel Dilution (%)", error=field_error(form_errors, "fuel_dilution")) %}
                                            {{ number_input(
                                                "fuel_dilution",
                                                "fuel_dilution",
                                                value=form_values.get("fuel_dilution", record.fuel_dilution if record else "")|default('', true),
                                                step="0.1",
                                                min="0",
                                                max="100",
                                                attrs={"placeholder": "e.g., 2.1"}
                                            ) }}
                                        {% endcall %}
                                </div>
                            </div>

                                {% set driving_conditions_value = form_values.get("driving_conditions") if form_values.get("driving_conditions") is not none else (record.driving_conditions if record else "") %}
                                {% set driving_options = [
                                    ("", "Select condition..."),
                                    ("Normal", "Normal"),
                                    ("Severe", "Severe"),
                                    ("Highway", "Mostly Highway"),
                                    ("City", "Mostly City"),
                                    ("Mixed", "Mixed")
                                ] %}
                                <div class="row">
                                <div class="col-md-6">
                                        {% call field("driving_conditions", "Driving Conditions", error=field_error(form_errors, "driving_conditions")) %}
                                            {{ select_input(
                                                "driving_conditions",
                                                "driving_conditions",
                                                driving_options,
                                                value=driving_conditions_value|default('', true),
                                                invalid=form_errors.get("driving_conditions")
                                            ) }}
                                        {% endcall %}
                                </div>
                                <div class="col-md-6">
                                        {% set coolant_value = form_values.get("coolant_contamination") %}
                                        {% set coolant_checked = coolant_value is not none %}
                                        {% if not coolant_checked and record and record.coolant_contamination %}
                                            {% set coolant_checked = True %}
                                        {% endif %}
                                        {% call field("coolant_contamination", "Coolant Contamination") %}
                                            {{ checkbox(
                                                "coolant_contamination",
                                                "coolant_contamination",
                                                checked=coolant_checked,
                                                label="Coolant Contamination Detected"
                                            ) }}
                                        {% endcall %}
                                    </div>
                                </div>

                                {% set oil_notes_value = form_values.get("oil_consumption_notes") %}
                                {% if oil_notes_value is none %}
                                    {% if record %}
                                        {% set oil_notes_value = record.oil_consumption_notes %}
                                    {% else %}
                                        {% set oil_notes_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("oil_consumption_notes", "Additional Notes", error=field_error(form_errors, "oil_consumption_notes")) %}
                                    {{ textarea(
                                        "oil_consumption_notes",
                                        "oil_consumption_notes",
                                        value=oil_notes_value|default('', true),
                                        rows=3,
                                        placeholder="Any additional observations or notes"
                                    ) }}
                                {% endcall %}

                                {% call field("photo", "Photo Documentation", error=field_error(form_errors, "photo")) %}
                                    <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
                                    <div class="form-text icon-row">
                                        <i class="fa-solid fa-circle-info me-1"></i>
                                        <span>Upload a photo of the oil sample or analysis setup</span>
                            </div>
                                    {% if record and record.photo_path %}
                                    <div class="mt-2">
                                        <img src="/{{ record.photo_path }}" alt="Oil analysis photo" class="img-fluid rounded" style="max-width: 300px;">
                                        <div class="mt-1">
                                            <small class="text-muted">{{ record.photo_description or 'No description' }}</small>
                                </div>
                            </div>
                                    {% endif %}
                                {% endcall %}

                                {% set analysis_photo_desc_value = form_values.get("photo_description") %}
                                {% if analysis_photo_desc_value is none %}
                                    {% if record %}
                                        {% set analysis_photo_desc_value = record.photo_description %}
                                    {% else %}
                                        {% set analysis_photo_desc_value = "" %}
                                    {% endif %}
                                {% endif %}
                                {% call field("analysis_photo_description", "Photo Description", error=field_error(form_errors, "photo_description")) %}
                                    {{ textarea(
                                        "analysis_photo_description",
                                        "photo_description",
                                        value=analysis_photo_desc_value|default('', true),
                                        rows=2,
                                        placeholder="Describe what's shown in the photo"
                                    ) }}
                                {% endcall %}

                                <input type="hidden" name="oil_analysis_date" value="{{ record.oil_analysis_date.strftime('%Y-%m-%d') if record and record.oil_analysis_date else '' }}">
                            {% endif %}

                            <div class="d-flex gap-2 justify-content-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fa-solid fa-floppy-disk fa-fw icon-left" aria-hidden="true"></i>
                                    <span>{% if record %}Update Record{% else %}Add Record{% endif %}</span>
                                </button>
                                <a href="{{ return_url }}" class="btn btn-outline-secondary">
                                    <span class="icon-row-sm">
                                        <i class="fa-solid fa-xmark icon-m icon-base"></i>
                                        <span>Cancel</span>
                                    </span>
                                </a>
                            </div>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/forms.js?v=1"></script>
    <script src="/static/export-data.js?v=3"></script>
    <script>
        // Auto-calculate total cost for oil changes
        function updateTotalCost() {
            if (document.getElementById('oil_cost')) {
                const oilCost = parseFloat(document.getElementById('oil_cost').value) || 0;
                const filterCost = parseFloat(document.getElementById('filter_cost').value) || 0;
                const laborCost = parseFloat(document.getElementById('labor_cost').value) || 0;
                const totalCost = oilCost + filterCost + laborCost;
            
                if (totalCost > 0) {
                    document.getElementById('cost').value = totalCost.toFixed(2);
                }
            }
        }

        // Add event listeners for cost calculation
        document.addEventListener('DOMContentLoaded', function() {
            const costFields = ['oil_cost', 'filter_cost', 'labor_cost'];
            costFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateTotalCost);
                }
            });
        });
    </script>
</body>
</html>